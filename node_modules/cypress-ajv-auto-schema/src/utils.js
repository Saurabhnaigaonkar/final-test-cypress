const fs = require('fs');
const path = require('path');
const generateSchema = require('generate-schema');

function resolveSchemasDir(configEnv) {
  // Allow override from Cypress env: cjsSchemasDir
  const custom = configEnv && configEnv.cjsSchemasDir;
  return custom || path.join(process.cwd(), 'cypress', 'fixtures', 'schemas');
}

function ensureDir(dir) {
  fs.mkdirSync(dir, { recursive: true });
}

function schemaFilePath(dir, name) {
  return path.join(dir, `${name}.json`);
}

function createSchemaFromJson(json, name = 'Response') {
  return generateSchema.json(name, json);
}

function saveSchema(dir, name, schema) {
  ensureDir(dir);
  const file = schemaFilePath(dir, name);
  fs.writeFileSync(file, JSON.stringify(schema, null, 2));
  return file;
}

function schemaExists(dir, name) {
  return fs.existsSync(schemaFilePath(dir, name));
}

module.exports = {
  resolveSchemasDir,
  ensureDir,
  schemaFilePath,
  createSchemaFromJson,
  saveSchema,
  schemaExists
};